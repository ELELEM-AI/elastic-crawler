#!/usr/bin/env ruby

# Load crawler environment
require_relative '../lib/environment'

# Standard libraries
require 'getoptlong'
require 'yaml'

#---------------------------------------------------------------------------------------------------
def die(message, print_help = false)
  puts "ERROR: #{message}"
  if print_help
    puts
    print_usage_help
  end

  exit(1)
end

#---------------------------------------------------------------------------------------------------
def print_usage_help
  puts "Usage: #{$PROGRAM_NAME} [options] CONFIG_FILE"
  puts
  puts 'Where:'
  puts ' --debug     Enable verbose mode (optional)'
  puts ' --help      Shows this help.'
  puts
  puts 'Useful examples:'
  puts " # #{$PROGRAM_NAME} crawler-name.yml"
  puts
end

#---------------------------------------------------------------------------------------------------
# Defaults
verbose_logging = false

# Parse options
opts = GetoptLong.new(
  ['--debug', '-v', GetoptLong::NO_ARGUMENT],
  ['--help',  '-h', GetoptLong::NO_ARGUMENT]
)

# Process options
begin
  opts.each do |opt, _arg|
    case opt
    when '--debug'
      verbose_logging = true
    when '--help'
      print_usage_help
      exit(0)
    end
  end
rescue GetoptLong::Error => e
  puts
  die(e, true)
end

# ES config path is static
es_config_file_path = "config/elasticsearch.yml"

# Validate and load the ES config file
die("ES config elasticsearch.yml does not exist!") unless File.readable?(es_config_file_path)
es_config =
  begin
    YAML.load_file(es_config_file_path)
  rescue StandardError => e
    die("Failed to load config elasticsearch.yml: #{e}")
  end

# Get crawler config file name from command line (last argument)
crawler_config_file = ARGV.shift
crawler_config_file_path = "config/crawlers/#{crawler_config_file}"

# Validate and load the crawler config file
die('Please specify the crawler config file!') unless crawler_config_file
die("Crawler config #{crawler_config_file.inspect} does not exist!") unless File.readable?(crawler_config_file_path)
crawler_config =
  begin
    YAML.load_file(crawler_config_file_path)
  rescue StandardError => e
    die("Failed to load crawler config #{crawler_config_file.inspect}: #{e}")
  end

# Combine configs and apply to crawler
config = es_config.merge(crawler_config)
crawl_config = Crawler::API::Config.new(**config.deep_symbolize_keys)
crawl = Crawler::API::Crawl.new(crawl_config)

# Perform the crawl!
crawl.start!
